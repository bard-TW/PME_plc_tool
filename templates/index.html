<!doctype html>
<html> 
    <!-- data-bs-theme="dark" -->
<head>
    <title>Modbus Scan</title>
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="crossorigin="anonymous"></script>

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- 表格 -->
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- 圖表 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js" 
    integrity="sha512-SIMGYRUjwY8+gKg7nn9EItdD8LCADSDfJNutF9TPrvEo86sQmFMh6MyralfIyhADlajSxqc7G0gs7+MwWF/ogQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* 自定義進度條動畫秒數 */
        .progress-bar {
            transition: width 1s ease-in-out; /* 在這裡調整動畫秒數，這裡設置為1秒 */
        }
    </style>
</head>

<body>
    <div class="progress" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="height: 1px">
        <div class="progress-bar" id="wait_time_progress" style="width: 0%"></div>
    </div>

    <div class="container-fluid text-center">
        <div class="row">
            <div class="col-lg-5 col-xl-4">
                <h3>Modbus 設定</h3>

                <div class="row g-2 my-2">
                    <div class="col d-grid gap-2">
                        <input type="file" class="btn btn-outline-success" id="fileInput" title="讀取點位資料" accept=".json">
                        <!-- <button type="button" class="btn btn-outline-success">讀取點位資料</button> -->
                    </div>
                    <div class="col d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="export_point_data()">儲存點位資料</button>
                    </div>
                </div>
                <div class="input-group g-2 my-2" id="basic_inforation">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="ip" placeholder="192.168.0.1" value="127.0.0.1" required>
                        <label for="floatingInputGrid">IP</label>
                    </div>
                    <div class="form-floating">
                        <input type="number" class="form-control" id="port" placeholder="502" value="5020" required>
                        <label for="floatingInputGrid">Port</label>
                    </div>
                    <button type="button" class="btn btn-outline-danger" id="disconnect_modbus_btu" onclick="disconnect_modbus()" style="display: none;">中斷</button>
                    <button type="button" class="btn btn-outline-primary" id="connect_modbus_btu"  onclick="connect_modbus()">連線</button>
                </div>

                <div class="input-group" id="basic_setting">
                    <div class="form-floating">
                        <input type="number" class="form-control " id="slave" placeholder="1" value="1" min="1">
                        <label for="floatingInputGrid">Slave</label>
                    </div>

                    <div class="form-floating">
                        <select class="form-select " id="point_type" aria-label="">
                            <option value="1">01: COIL STATUS</option>
                            <option value="2">02: INPUT STATUS</option>
                            <option selected value="3">03: HOLDING REGISTER</option>
                            <option value="4">04: INPUT REGISTER</option>
                        </select>
                        <label for="point_type"> 型態(其他有問題)</label>
                        <!-- Modbus Point Type -->
                    </div>
                    <div class="form-floating">
                        <input type="number" class="form-control " id="time_sleep" placeholder="1" value="1" step="1" min="1">
                        <label for="floatingInputGrid">延遲秒數</label>
                    </div>
                </div>

                <div class="progress g-2 my-2" role="progressbar" aria-label="Animated striped example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%" id="progressbar">連線中</div>
                </div>

                <div class="row g-2 my-2">
                    <div class="col">
                        <label class="align-middle">點位動作：</label>
                    </div>
                    <div class="col d-grid gap-2">
                        <button type="button" class="btn btn-outline-success" onclick="add_point()">新增</button>
                    </div>
                    <div class="col d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="copy_point()">複製</button>
                    </div>
                    <div class="col d-grid gap-2">
                        <button type="button" class="btn btn-outline-danger" onclick="del_point()">刪除</button>
                    </div>
                </div>

                <div class="g-2 my-2">
                    <table id="modbus_setting_table" class="display compact" style="width:100%">
                        <thead>
                            <tr>
                                <th></th>
                                <th>名稱</th>
                                <th>點位</th>
                                <th>型態</th>
                                <th>及時結果</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

            <div class="col-lg-7 col-xl-8">
                <h3>Logs 表格</h3>

                <div class="row g-2 my-2">
                    <div class="col d-grid gap-2">
                        <button type="button" class="btn btn-outline-success" onclick="reset_history_checkbox()">初始化\重置表格</button>
                    </div>
                </div>

                <div id="show_switch" class="row user-select-none"></div>

                <br>
                <table id="history_table" class="display compact" style="width:100%">
                    <thead>
                        <tr>
                            <th>時間</th>
                        </tr>
                    </thead>
                </table>

                <div>
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/datatable.js') }}"></script>
    <script type="text/javascript">
        var socket = io.connect();

        socket.on('disconnect', function (data) {
            disconnect_modbus()
            alert('與伺服器連線中斷，請重新整理頁面')
        });

        socket.on('connect_modbus', function (data) {
            // 連線中
            console.log(data)
            $("#progressbar").css("width", data.progress);
            $("#progressbar").text(data.msg);

            if (data.progress === '0%'){
            $("#connect_modbus_btu").prop("disabled", false);
            $("#ip").prop("disabled", false);
            $("#port").prop("disabled", false);
            $("#disconnect_modbus_btu").hide()
            $("#connect_modbus_btu").show()
            $("#disconnect_modbus_btu").prop("disabled", false);
            }
        });

        socket.on('wait_time_progress', function (data) {
            $("#wait_time_progress").css("width", data.progress);
        });

        socket.on('connect_modbus_error', function (data) {
            // 無法連線
            alert(data.data)
            $("#connect_modbus_btu").prop("disabled", false);

            $("#progressbar").css("width", "0%");
            $("#progressbar").text("連線失敗");

            $("#ip").prop("disabled", false);
            $("#port").prop("disabled", false);

            $("#disconnect_modbus_btu").hide()
            $("#connect_modbus_btu").show()
            
        });

        socket.on('connect_modbus_success', function (data) {
            // 連線成功
            $("#progressbar").css("width", "100%");
            $("#progressbar").text("連線成功");

            $("#connect_modbus_btu").hide()
            $("#disconnect_modbus_btu").show()

            $("#slave").change()
            socket.emit("update_point_data", modbus_setting_data, '');
        });

        socket.on('modbus_value', function (data) {
            // 連線成功
            for (const [index, value] of modbus_setting_data.entries()){
                if (value.id in data){
                    modbus_setting_table.cell(index, 4).data(data[value.id].now_value)
                }
            }
        });

        socket.on('update_history', function (data) {
            // 連線成功
            // console.log(arraysAreEqual(history_columns_list, Object.keys(data)))
            if (arraysAreEqual(history_columns_list, Object.keys(data)) === false){
                reset_history_checkbox()
                history_columns_list = Object.keys(data)
            }

            history_table.row.add(data).draw()
            rowCount = history_table.rows().count();
            if (rowCount > 1000) {
                history_table.row(0).remove().draw(false);
            }
        });


        // var aa = ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange']
        // var bb = [12, 19, 3, 5, 2, 3]
        // var cc = [12, 8, 9, 5, 2, 3]
        // const ctx = document.getElementById('myChart');
        // var myLineChart = new Chart(ctx, {
        //     type: 'line',
        //     data: {
        //     labels: aa,
        //     datasets: [{
        //         label: '# of Votes',
        //         data: bb
        //     },{
        //         label: 'cc',
        //         data: cc
        //     }]
        //     }
        // });
        
        // aa.shift()
        // bb.shift()
        // aa.push('aa')
        // bb.push(6)
        // myLineChart.update()
        // myLineChart.destroy()
    </script>
</body>
</html>

