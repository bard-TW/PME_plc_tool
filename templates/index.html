<!doctype html>
<html>

<head>
    <title>Modbus Scan</title>
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">

    <!-- 表格 -->
    <link href="https://cdn.datatables.net/1.13.2/css/jquery.dataTables.min.css" rel="stylesheet" />
    <script src="https://cdn.datatables.net/1.13.2/js/jquery.dataTables.min.js"></script>
</head>

<body>


    <div class="container-fluid text-center">
        <div class="row">

            <div class="col-lg-5 col-xl-4">
                <h3>Modbus 設定</h3>
                <br>
                <div class="row g-2 my-2">
                    <div class="col-sm-8">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="ip" placeholder="192.168.0.1" value="127.0.0.1">
                            <label for="floatingInputGrid">IP</label>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="port" placeholder="502" value="502">
                            <label for="floatingInputGrid">Port</label>
                        </div>
                    </div>
                </div>


                <div class="row g-2 my-2 on_change">
                    <div class="col-sm-4">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="slave" placeholder="1" value="1">
                            <label for="floatingInputGrid">Slave</label>
                        </div>
                    </div>
                    <div class="col-sm-8">
                        <div class="form-floating">
                            <select class="form-select" id="point_type" aria-label="Floating label select example">
                                <option value="1">01: COIL STATUS</option>
                                <option value="2">02: INPUT STATUS</option>
                                <option selected value="3">03: HOLDING REGISTER</option>
                                <option value="4">04: INPUT REGISTER</option>
                            </select>
                            <label for="point_type">Modbus Point Type</label>
                        </div>
                    </div>
                </div>

                <div id="container" class="on_change">
                </div>

                <div id="progressbar" class="g-2 my-2"></div><!-- 進度條 -->

                <button type="button" class="btn btn-outline-danger" id="disconnect_modbus_btu" onclick="disconnect_modbus()" disabled>中斷連線</button>
                <button type="button" class="btn btn-outline-info" onclick="add_point()">新增測量點</button>
                <button type="button" class="btn btn-outline-primary" id="connect_modbus_btu" onclick="connect_modbus()">連線</button>
            </div>
            <div class="col-lg-7 col-xl-8">
                <h3>Logs 表格</h3>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    <script type="text/javascript">
        var socket = io.connect();
        var divCount = 0;

        socket.on('disconnect', function (data) {
            alert('與伺服器連線中斷，請重新整理頁面')
        });


        // socket.emit('my event', {data: 'I\'m connected!'});
        function connect_modbus() {
            // 連線
            ip = $("#ip").val()
            port = $("#port").val()
            socket.emit("connect_modbus", ip, port);
            
            $("#connect_modbus_btu").prop("disabled", true);
            $("#ip").prop("disabled", true);
            $("#port").prop("disabled", true);

            $("#progressbar").html(`<div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 50%">連線中</div>
            </div>
            `)

        }

        function disconnect_modbus() {
            // 中斷連線
            socket.emit("disconnect_modbus");
            $("#disconnect_modbus_btu").prop("disabled", true);
            $("#connect_modbus_btu").prop("disabled", false);
            $("#ip").prop("disabled", false);
            $("#port").prop("disabled", false);
        }

        socket.on('connect_modbus_error', function (data) {
            // 無法連線
            alert(data.data)
            $("#disconnect_modbus_btu").prop("disabled", true);
            $("#connect_modbus_btu").prop("disabled", false);
            $("#progressbar").html('')
            $("#ip").prop("disabled", false);
            $("#port").prop("disabled", false);
        });

        socket.on('connect_modbus_success', function (data) {
            // 連線成功
            $("#disconnect_modbus_btu").prop("disabled", false);
            $("#progressbar").html('')
        });

        function add_point() {
            divCount++; // 增加 <div> 數量
            newDiv = `
            <div class="row g-2 my-2" style="border: 2px solid rgb(128, 236, 255);" id="point_${divCount}" name="point">
                <div class="input-group">
                    <span class="input-group-text" id="basic" title="ID">${divCount}</span>

                    <label class="input-group-text" for="log${divCount}">
                        <input class="form-check-input mt-0" type="checkbox"
                            aria-label="Checkbox for following text input" id="log${divCount}" title="紀錄Logs">
                    </label>

                    <div class="form-floating">
                        <input type="text" class="form-control" id="title${divCount}" placeholder="欄位名稱">
                        <label for="title">logs的欄位名稱</label>
                    </div>
                    <span class="input-group-text" id="now_data${divCount}" title="及時顯示資料">123456</span>
                </div>

                <div class="input-group my-2">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="address${divCount}" placeholder="點位" value="3000">
                        <label for="title">點位</label>
                    </div>

                    <div class="form-floating">
                        <select class="form-select" id="data_type${divCount}">
                            <option value="int16">int16</option>
                            <option value="int32" selected>int32</option>
                            <option value="int64">int64</option>
                            <option value="uint16">uint16</option>
                            <option value="uint32">uint32</option>
                            <option value="uint64">uint64</option>
                            <option value="float16">float16</option>
                            <option value="float32">float32</option>
                            <option value="float64">float64</option>
                        </select>
                        <label for="data_type">資料型態</label>
                    </div>


                    <button class="btn btn-outline-danger" type="button" onclick="del_point(this)"><i class="bi bi-trash-fill"></i></button>
                </div>
            </div>
            `

            $("#container").append(newDiv);
        }
        add_point()
        function del_point(event) {
            $(event).parent().parent().remove()
            $("#slave").trigger("change");
        }

        $(".on_change").on("change", "input, select", function () {
            point_data = {}
            for (value of $("#container").children()){
                num = $(value).find("#basic").text()

                log = $(value).find(`#log${num}:checked`).length
                title = $(value).find(`#title${num}`).val()
                address = $(value).find(`#address${num}`).val()
                data_type = $(value).find(`#data_type${num}`).val()
                console.log(data_type)

                point_data[num] = {'log': log, 'title': title, 'address': address, 'data_type': data_type}
            }

            point_type = $("#point_type").val()
            slave = $("#slave").val()
            data = {'point_type': point_type, 'slave': slave, 'point_data': point_data}
            console.log(data)
            socket.emit("modbus_point_data", data);
        });

        socket.on('modbus_value', function (data) {
            $(`#now_data${data.key}`).html(data.data);
        });


    </script>
</body>

</html>








